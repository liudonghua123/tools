import{_ as W}from"./monaco-editor-DrHUTMTD.js";import{_ as Z,u as ee,r as f,o as te,a as oe,c,j as d,d as s,h as se,s as ae,F as U,f as z,t as b,e as E,n as ne,i as le,b as re,g as ie}from"./index-BL10sSGN.js";import ce from"./MonacoEditor-CY7Kln0m.js";import{f as de,a as T}from"./ExampleLoader-C0CuCz3g.js";import{x as ue,a as me}from"./xterm-Btcyv0ds.js";import{u as we}from"./untar-D4OOux-1.js";const fe={class:"flex flex-col md:flex-row h-full"},pe={class:"w-full md:w-1/2 h-1/2 md:h-full flex flex-col border-b md:border-b-0 md:border-r border-slate-700"},be={class:"flex items-center justify-between px-4 py-3 border-b border-slate-700 bg-slate-800/50"},ge={class:"flex items-center gap-2"},ve={class:"relative group ml-2"},he=["label"],ye=["value"],xe={key:0,class:"text-xs px-2 py-0.5 bg-emerald-600 text-white rounded-full"},_e={key:1,class:"text-xs px-2 py-0.5 bg-slate-600 text-slate-300 rounded-full"},ke=["disabled"],Ce={key:0,class:"w-4 h-4 animate-spin",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Be={key:1,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24"},Fe={class:"flex-1 min-h-0"},Re={class:"w-full md:w-1/2 h-1/2 md:h-full flex flex-col bg-slate-900 border-t md:border-t-0 md:border-l border-slate-700"},De={class:"flex items-center justify-between px-4 py-3 border-b border-slate-700"},Ee={class:"flex items-center gap-3"},Ie={class:"text-xs font-bold text-slate-400 uppercase tracking-wider"},Me={key:0,class:"text-xs text-slate-500"},Le={class:"flex-1 min-h-0 p-2 bg-[#0f172a]"},Oe={__name:"CobolRunner",emits:["ready"],setup(Pe,{emit:j}){let g,M,C,L;const{t:B}=ee(),S=j,v=f(""),O=f(null),h=f(""),i=f(!1),y=f(!1),F=f(null),l=f("");let e=null,x=null;const P=f(null),N=()=>{e=new ue.Terminal({cursorBlink:!0,fontSize:14,fontFamily:'Menlo, Monaco, "Courier New", monospace',theme:{background:"#0f172a",foreground:"#e2e8f0"}}),x=new me.FitAddon,e.loadAddon(x),e.open(P.value),x.fit(),e.write(`\x1B[38;5;244mResult will appear here...\x1B[0m\r
`)};let u=null;const G=async()=>{i.value=!0,l.value="Initializing Wasmer...";try{window.crossOriginIsolated||(l.value="Loading COEP Service Worker...",await new Promise(o=>{const r=document.createElement("script");r.src="/tools/cobol-wasm/coi-serviceworker.js",r.onload=o,r.onerror=o,document.head.appendChild(r)}));const a=await W(()=>import("./index-cr_cxuU3.js"),[]);g=a.Wasmer,M=a.init,C=a.Directory,L=(await W(()=>import("./wasmer_js_bg-D-_5TxHf.js"),[])).default,await M({module:L}),l.value="Downloading System Root...";const n=await(await fetch("/tools/cobol-wasm/sysroot.tar")).arrayBuffer();l.value="Extracting System Root...";const w=await we.untar(n),_={},p={},I={};for(const o of w)if(o.filename.startsWith("sysroot32/")){const r=o.filename.replace("sysroot32/","");o.fileData&&o.fileData.byteLength>0&&(_[r]=new Uint8Array(o.fileData))}else if(o.filename.startsWith("lib-small/")){const r=o.filename.replace("lib-small/","");o.fileData&&o.fileData.byteLength>0&&(p[r]=new Uint8Array(o.fileData))}else o.fileData&&o.fileData.byteLength>0&&(I[o.filename]=new Uint8Array(o.fileData));l.value="Downloading Compilers...";const[$,k,A]=await Promise.all([fetch("/tools/cobol-wasm/cobc").then(o=>o.arrayBuffer()),fetch("/tools/cobol-wasm/clang").then(o=>o.arrayBuffer()),fetch("/tools/cobol-wasm/wasm-ld").then(o=>o.arrayBuffer())]);u={cobc:new Uint8Array($),clang:new Uint8Array(k),wasmld:new Uint8Array(A),sysrootFiles:_,libFiles:p,rootFiles:I},y.value=!0,l.value="",S("ready")}catch(a){console.error("Wasmer Init Error",a),l.value="Failed to initialize: "+a.message,e.write(`\r
\x1B[31mError initializing: ${a.message}\x1B[0m\r
`)}finally{i.value=!1}},H=async()=>{if(!u||!y.value)return;i.value=!0,l.value="Compiling...",e.clear();const a=performance.now();try{const t=new C(u.sysrootFiles),m=new C(u.libFiles),n=new C(u.rootFiles);await n.writeFile("test.cob",new TextEncoder().encode(v.value)),e.write(`Checking cobc version...\r
`);const w=await g.fromFile(u.cobc);try{const D=await(await w.entrypoint.run({args:["--version"],mount:{"/":n,"/sysroot":t,"/lib":m},env:{COB_CONFIG_DIR:"/sysroot/share/gnucobol/config"}})).wait();console.log("Cobc Version Result:",D),D.code!==0?e.write(`\x1B[33mWarning: cobc --version returned ${D.code}\x1B[0m\r
`):e.write(D.stdout)}catch(R){throw console.error("Version check failed",R),e.write(`\x1B[31mVersion check failed: ${R.message}\x1B[0m\r
`),R}e.write(`Running cobc compilation...\r
`);const _=await w.entrypoint.run({args:["-C","-x","/test.cob","-o","/test.c"],mount:{"/":n,"/sysroot":t,"/lib":m},env:{COB_CONFIG_DIR:"/sysroot/share/gnucobol/config"},cwd:"/"});console.log("Cobc Instance started",_);const p=await _.wait();if(console.log("Cobc Result",p),p.code!==0)throw e.write(p.stderr),new Error(`cobc failed with code ${p.code}`);e.write(`cobc done.\r
`),e.write(`Running clang...\r
`);const k=await(await(await g.fromFile(u.clang)).entrypoint.run({args:["-cc1","-triple","wasm32-unknown-wasi","-emit-obj","-disable-free","-isysroot","/sysroot","-internal-isystem","/lib/clang/16/include","-internal-isystem","/sysroot/include/wasm32-wasi","-internal-isystem","/sysroot/include","-ferror-limit","19","-o","/test.o","-x","c","/test.c"],mount:{"/":n,"/sysroot":t,"/lib":m},cwd:"/"})).wait();if(k.code!==0)throw e.write(k.stderr),new Error(`clang failed with code ${k.code}`);e.write(`clang done.\r
`),e.write(`Running wasm-ld...\r
`);const r=await(await(await g.fromFile(u.wasmld)).entrypoint.run({args:["-m","wasm32","-L/sysroot/lib","-L/sysroot/lib/wasm32-wasi","/sysroot/lib/wasm32-wasi/crt1-command.o","--export-dynamic","--export=__heap_base","--export=__stack_pointer","--export=__data_end","-lpthread","-lc","/lib/clang/16/lib/wasi/libclang_rt.builtins-wasm32.a","/test.o","-lc","-lcob","-lgmp","-lm","-o","/test.wasm"],mount:{"/":n,"/sysroot":t,"/lib":m},cwd:"/"})).wait();if(r.code!==0)throw e.write(r.stderr),new Error(`wasm-ld failed with code ${r.code}`);e.write(`Linking done.\r
`);const Q=await n.readFile("test.wasm");e.write(`Running program...\r
`);const X=await(await(await g.fromFile(Q)).entrypoint.run({mount:{}})).wait();e.write(X.stdout);const Y=performance.now();F.value=(Y-a).toFixed(2)}catch(t){console.error(t),e.write(`\r
\x1B[31mError: ${t.message}\x1B[0m\r
`)}finally{i.value=!1,l.value=""}},K=async()=>{try{const a=await de("cobol");if(O.value=a,a.chapters&&a.chapters.length>0&&a.chapters[0].examples.length>0){const t=a.chapters[0].examples[0];h.value=t.path,v.value=await T("cobol",t.path)}}catch(a){console.error("Failed to load COBOL manifest:",a)}},q=async()=>{if(h.value){e.clear();try{i.value=!0,l.value="Loading example...",v.value=await T("cobol",h.value)}catch(a){e.write(`\x1B[31mFailed to load example: ${a.message}\x1B[0m\r
`)}finally{i.value=!1,l.value=""}}},J=()=>{e.clear(),F.value=null};te(async()=>{N(),K(),await G(),window.addEventListener("resize",V)}),oe(()=>{window.removeEventListener("resize",V),e&&e.dispose()});const V=()=>{x&&x.fit()};return(a,t)=>{var m;return d(),c("div",fe,[s("div",pe,[s("div",be,[s("div",ge,[t[3]||(t[3]=s("svg",{class:"w-5 h-5 text-blue-500",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"})],-1)),t[4]||(t[4]=s("span",{class:"font-bold text-white"},"COBOL",-1)),s("div",ve,[se(s("select",{"onUpdate:modelValue":t[0]||(t[0]=n=>h.value=n),onChange:q,class:"appearance-none bg-slate-700/50 border border-slate-600 text-slate-200 text-xs rounded px-2 pr-6 py-1 hover:border-slate-500 focus:outline-none focus:ring-1 focus:ring-blue-500 transition-all cursor-pointer"},[(d(!0),c(U,null,z((m=O.value)==null?void 0:m.chapters,n=>(d(),c("optgroup",{key:n.title,label:n.title},[(d(!0),c(U,null,z(n.examples,w=>(d(),c("option",{key:w.path,value:w.path},b(w.name),9,ye))),128))],8,he))),128))],544),[[ae,h.value]]),t[2]||(t[2]=s("div",{class:"absolute inset-y-0 right-1.5 flex items-center pointer-events-none text-slate-400"},[s("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"})])],-1))]),y.value?(d(),c("span",xe,b(E(B)("tools.code-playground.common.ready")),1)):(d(),c("span",_e,b(l.value||"Loading..."),1))]),s("button",{onClick:H,disabled:i.value||!y.value,class:ne(["px-4 py-1.5 rounded-lg font-medium text-sm transition-colors flex items-center gap-2",i.value||!y.value?"bg-slate-600 text-slate-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-500 text-white"])},[i.value?(d(),c("svg",Ce,[...t[5]||(t[5]=[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"},null,-1)])])):(d(),c("svg",Be,[...t[6]||(t[6]=[s("path",{d:"M8 5v14l11-7z"},null,-1)])])),le(" "+b(i.value?"Running...":E(B)("tools.code-playground.common.run")),1)],10,ke)]),s("div",Fe,[re(ce,{modelValue:v.value,"onUpdate:modelValue":t[1]||(t[1]=n=>v.value=n),language:"cobol",height:"100%",minimap:!1},null,8,["modelValue"])])]),s("div",Re,[s("div",De,[s("div",Ee,[s("span",Ie,b(E(B)("tools.code-playground.common.output")),1),F.value?(d(),c("span",Me,b(F.value)+"ms",1)):ie("",!0)]),s("button",{onClick:J,class:"text-xs text-slate-500 hover:text-white transition-colors"},b(E(B)("tools.code-playground.common.clear")),1)]),s("div",Le,[s("div",{ref_key:"terminalContainer",ref:P,class:"w-full h-full"},null,512)])])])}}},Se=Z(Oe,[["__scopeId","data-v-0fc59e91"]]);export{Se as default};
