import{_ as Q}from"./monaco-editor-DrHUTMTD.js";import{_ as X,u as Y,r as w,o as Z,a as ee,c,j as d,d as s,h as te,s as oe,F as W,f as j,t as f,e as E,n as se,i as ae,b as le,g as ne}from"./index-Q3LHmwEb.js";import re from"./MonacoEditor-FjlAfSZ3.js";import{f as ie,a as z}from"./ExampleLoader-C0CuCz3g.js";import{x as ce,a as de}from"./xterm-Btcyv0ds.js";import{u as me}from"./untar-D4OOux-1.js";const ue={class:"flex flex-col md:flex-row h-full"},we={class:"w-full md:w-1/2 h-1/2 md:h-full flex flex-col border-b md:border-b-0 md:border-r border-slate-700"},fe={class:"flex items-center justify-between px-4 py-3 border-b border-slate-700 bg-slate-800/50"},pe={class:"flex items-center gap-2"},be={class:"relative group ml-2"},ge=["label"],xe=["value"],ye={key:0,class:"text-xs px-2 py-0.5 bg-emerald-600 text-white rounded-full"},he={key:1,class:"text-xs px-2 py-0.5 bg-slate-600 text-slate-300 rounded-full"},ve=["disabled"],_e={key:0,class:"w-4 h-4 animate-spin",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},ke={key:1,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24"},Ce={class:"flex-1 min-h-0"},Fe={class:"w-full md:w-1/2 h-1/2 md:h-full flex flex-col bg-slate-900 border-t md:border-t-0 md:border-l border-slate-700"},Be={class:"flex items-center justify-between px-4 py-3 border-b border-slate-700"},De={class:"flex items-center gap-3"},Ee={class:"text-xs font-bold text-slate-400 uppercase tracking-wider"},Re={key:0,class:"text-xs text-slate-500"},Le={class:"flex-1 min-h-0 p-2 bg-[#0f172a]"},Ie={__name:"CobolRunner",emits:["ready"],setup(Me,{emit:O}){let y,I,h;const{t:B}=Y(),U=O,v=w(""),M=w(null),_=w(""),r=w(!1),k=w(!1),D=w(null),l=w("");let t=null,C=null;const $=w(null),V=()=>{t=new ce.Terminal({cursorBlink:!0,fontSize:14,fontFamily:'Menlo, Monaco, "Courier New", monospace',theme:{background:"#0f172a",foreground:"#e2e8f0"}}),C=new de.FitAddon,t.loadAddon(C),t.open($.value),C.fit(),t.write(`\x1B[38;5;244mResult will appear here...\x1B[0m\r
`)};let u=null;const T=async()=>{r.value=!0,l.value="Initializing Wasmer...";try{window.crossOriginIsolated||(l.value="Loading COEP Service Worker...",await new Promise(e=>{const m=document.createElement("script");m.src="/tools/cobol-wasm/coi-serviceworker.js",m.onload=e,m.onerror=e,document.head.appendChild(m)}));const a=await Q(()=>import("/tools/cobol-wasm/wasmer-sdk/index.mjs"),[]);y=a.Wasmer,I=a.init,h=a.Directory,await I({module:"/tools/cobol-wasm/wasmer-sdk/wasmer_js_bg.wasm"}),l.value="Downloading System Root...";const p=await(await fetch("/tools/cobol-wasm/sysroot.tar")).arrayBuffer();l.value="Extracting System Root...";const n=await me.untar(p),i={},b={},g={};for(const e of n)if(e.filename.startsWith("sysroot32/")){const m=e.filename.replace("sysroot32/","");e.fileData&&e.fileData.byteLength>0&&(i[m]=new Uint8Array(e.fileData))}else if(e.filename.startsWith("lib-small/")){const m=e.filename.replace("lib-small/","");e.fileData&&e.fileData.byteLength>0&&(b[m]=new Uint8Array(e.fileData))}else e.fileData&&e.fileData.byteLength>0&&(g[e.filename]=new Uint8Array(e.fileData));l.value="Downloading Compilers...";const[F,R,A]=await Promise.all([fetch("/tools/cobol-wasm/cobc").then(e=>e.arrayBuffer()),fetch("/tools/cobol-wasm/clang").then(e=>e.arrayBuffer()),fetch("/tools/cobol-wasm/wasm-ld").then(e=>e.arrayBuffer())]);u={cobc:new Uint8Array(F),clang:new Uint8Array(R),wasmld:new Uint8Array(A),sysrootFiles:i,libFiles:b,rootFiles:g},k.value=!0,l.value="",U("ready")}catch(a){console.error("Wasmer Init Error",a),l.value="Failed to initialize: "+a.message,t.write(`\r
\x1B[31mError initializing: ${a.message}\x1B[0m\r
`)}finally{r.value=!1}},S=async()=>{if(!u||!k.value)return;r.value=!0,l.value="Compiling...",t.clear();const a=performance.now();try{const o=new h(u.sysrootFiles),p=new h(u.libFiles),n=new h(u.rootFiles),i=new h,b={"/":n,"/sysroot":o,"/lib":p,"/src":i},g={COB_CONFIG_DIR:"/sysroot/share/gnucobol/config"},F="/src";await i.writeFile("test.cob",new TextEncoder().encode(v.value));const R=await y.fromFile(u.cobc);t.write(`Running cobc compilation...\r
`);const e=await(await R.entrypoint.run({args:["-C","-x","/src/test.cob","-o","/src/test.c"],mount:b,env:g,cwd:F})).wait();if(e.code!==0)throw new Error(`cobc failed with code ${e.code}`);t.write(`cobc done.\r
`),t.write(`Running clang...\r
`);const x=await(await(await y.fromFile(u.clang)).entrypoint.run({args:["-cc1","-triple","wasm32-unknown-wasi","-emit-obj","-disable-free","-isysroot","/sysroot","-internal-isystem","/lib/clang/16/include","-internal-isystem","/sysroot/include/wasm32-wasi","-internal-isystem","/sysroot/include","-ferror-limit","19","-o","/src/test.o","-x","c","/src/test.c"],mount:b,env:g,cwd:F})).wait();if(x.stdout&&t.write(x.stdout),x.stderr&&t.write(x.stderr),x.code!==0)throw new Error(`clang failed with code ${x.code}`);t.write(`clang done.\r
`),t.write(`Running wasm-ld...\r
`);const L=await(await(await y.fromFile(u.wasmld)).entrypoint.run({args:["-m","wasm32","-L/sysroot/lib","-L/sysroot/lib/wasm32-wasi","--shared-memory","--max-memory=4294967296","--import-memory","--export-dynamic","--export=__heap_base","--export=__stack_pointer","--export=__data_end","--export=__wasm_init_tls","--export=__wasm_signal","--export=__tls_size","--export=__tls_align","--export=__tls_base","/sysroot/lib/wasm32-wasi/crt1-command.o","/lib/clang/16/lib/wasi/libclang_rt.builtins-wasm32.a","test.o","-lc","-lpthread","-lcob","-lgmp","-lwasi-emulated-signal","-lwasi-emulated-getpid","-lwasi-emulated-mman","-lsetjmp","-ldl","-o","test.wasm"],mount:b,env:g,cwd:F})).wait();if(L.code!==0)throw t.write(L.stderr),new Error(`wasm-ld failed with code ${L.code}`);t.write(`Linking done.\r
`);const K=await i.readFile("test.wasm");t.write(`Running program...\r
`);const q=await(await(await y.fromFile(K)).entrypoint.run({mount:{}})).wait();t.write(q.stdout);const J=performance.now();D.value=(J-a).toFixed(2)}catch(o){console.error(o),t.write(`\r
\x1B[31mError: ${o.message}\x1B[0m\r
`)}finally{r.value=!1,l.value=""}},N=async()=>{try{const a=await ie("cobol");if(M.value=a,a.chapters&&a.chapters.length>0&&a.chapters[0].examples.length>0){const o=a.chapters[0].examples[0];_.value=o.path,v.value=await z("cobol",o.path)}}catch(a){console.error("Failed to load COBOL manifest:",a)}},H=async()=>{if(_.value){t.clear();try{r.value=!0,l.value="Loading example...",v.value=await z("cobol",_.value)}catch(a){t.write(`\x1B[31mFailed to load example: ${a.message}\x1B[0m\r
`)}finally{r.value=!1,l.value=""}}},G=()=>{t.clear(),D.value=null};Z(async()=>{V(),N(),await T(),window.addEventListener("resize",P)}),ee(()=>{window.removeEventListener("resize",P),t&&t.dispose()});const P=()=>{C&&C.fit()};return(a,o)=>{var p;return d(),c("div",ue,[s("div",we,[s("div",fe,[s("div",pe,[o[3]||(o[3]=s("svg",{class:"w-5 h-5 text-blue-500",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"})],-1)),o[4]||(o[4]=s("span",{class:"font-bold text-white"},"COBOL",-1)),s("div",be,[te(s("select",{"onUpdate:modelValue":o[0]||(o[0]=n=>_.value=n),onChange:H,class:"appearance-none bg-slate-700/50 border border-slate-600 text-slate-200 text-xs rounded px-2 pr-6 py-1 hover:border-slate-500 focus:outline-none focus:ring-1 focus:ring-blue-500 transition-all cursor-pointer"},[(d(!0),c(W,null,j((p=M.value)==null?void 0:p.chapters,n=>(d(),c("optgroup",{key:n.title,label:n.title},[(d(!0),c(W,null,j(n.examples,i=>(d(),c("option",{key:i.path,value:i.path},f(i.name),9,xe))),128))],8,ge))),128))],544),[[oe,_.value]]),o[2]||(o[2]=s("div",{class:"absolute inset-y-0 right-1.5 flex items-center pointer-events-none text-slate-400"},[s("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"})])],-1))]),k.value?(d(),c("span",ye,f(E(B)("tools.code-playground.common.ready")),1)):(d(),c("span",he,f(l.value||"Loading..."),1))]),s("button",{onClick:S,disabled:r.value||!k.value,class:se(["px-4 py-1.5 rounded-lg font-medium text-sm transition-colors flex items-center gap-2",r.value||!k.value?"bg-slate-600 text-slate-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-500 text-white"])},[r.value?(d(),c("svg",_e,[...o[5]||(o[5]=[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"},null,-1)])])):(d(),c("svg",ke,[...o[6]||(o[6]=[s("path",{d:"M8 5v14l11-7z"},null,-1)])])),ae(" "+f(r.value?"Running...":E(B)("tools.code-playground.common.run")),1)],10,ve)]),s("div",Ce,[le(re,{modelValue:v.value,"onUpdate:modelValue":o[1]||(o[1]=n=>v.value=n),language:"cobol",height:"100%",minimap:!1},null,8,["modelValue"])])]),s("div",Fe,[s("div",Be,[s("div",De,[s("span",Ee,f(E(B)("tools.code-playground.common.output")),1),D.value?(d(),c("span",Re,f(D.value)+"ms",1)):ne("",!0)]),s("button",{onClick:G,class:"text-xs text-slate-500 hover:text-white transition-colors"},f(E(B)("tools.code-playground.common.clear")),1)]),s("div",Le,[s("div",{ref_key:"terminalContainer",ref:$,class:"w-full h-full"},null,512)])])])}}},Ne=X(Ie,[["__scopeId","data-v-e99fa515"]]);export{Ne as default};
