import{_ as Q}from"./monaco-editor-DrHUTMTD.js";import{_ as X,u as Y,r as u,o as Z,a as ee,c,j as d,d as s,h as te,s as oe,F as P,f as W,t as w,e as R,n as se,i as ae,b as le,g as ne}from"./index-hw7nIlup.js";import re from"./MonacoEditor-D1-m5bfC.js";import{f as ie,a as j}from"./ExampleLoader-C0CuCz3g.js";import{x as ce,a as de}from"./xterm-Btcyv0ds.js";import{u as me}from"./untar-D4OOux-1.js";const ue={class:"flex flex-col md:flex-row h-full"},we={class:"w-full md:w-1/2 h-1/2 md:h-full flex flex-col border-b md:border-b-0 md:border-r border-slate-700"},fe={class:"flex items-center justify-between px-4 py-3 border-b border-slate-700 bg-slate-800/50"},pe={class:"flex items-center gap-2"},be={class:"relative group ml-2"},ge=["label"],xe=["value"],ye={key:0,class:"text-xs px-2 py-0.5 bg-emerald-600 text-white rounded-full"},he={key:1,class:"text-xs px-2 py-0.5 bg-slate-600 text-slate-300 rounded-full"},ve=["disabled"],_e={key:0,class:"w-4 h-4 animate-spin",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},ke={key:1,class:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24"},Fe={class:"flex-1 min-h-0"},Ce={class:"w-full md:w-1/2 h-1/2 md:h-full flex flex-col bg-slate-900 border-t md:border-t-0 md:border-l border-slate-700"},Be={class:"flex items-center justify-between px-4 py-3 border-b border-slate-700"},De={class:"flex items-center gap-3"},Re={class:"text-xs font-bold text-slate-400 uppercase tracking-wider"},Ee={key:0,class:"text-xs text-slate-500"},Le={class:"flex-1 min-h-0 p-2 bg-[#0f172a]"},Me={__name:"CobolRunner",emits:["ready"],setup(Ie,{emit:U}){let x,M,y;const{t:C}=Y(),V=U,h=u(""),I=u(null),v=u(""),r=u(!1),_=u(!1),B=u(null),l=u("");let e=null,k=null;const $=u(null),O=()=>{e=new ce.Terminal({cursorBlink:!0,fontSize:14,fontFamily:'Menlo, Monaco, "Courier New", monospace',theme:{background:"#0f172a",foreground:"#e2e8f0"}}),k=new de.FitAddon,e.loadAddon(k),e.open($.value),k.fit(),e.write(`\x1B[38;5;244mResult will appear here...\x1B[0m\r
`)};let m=null;const T=async()=>{r.value=!0,l.value="Initializing Wasmer...";try{const a=await Q(()=>import("/tools/cobol-wasm/wasmer-sdk/index.mjs"),[]);x=a.Wasmer,M=a.init,y=a.Directory,await M({module:"/tools/cobol-wasm/wasmer-sdk/wasmer_js_bg.wasm"}),l.value="Downloading System Root...";const f=await(await fetch("/tools/cobol-wasm/sysroot.tar")).arrayBuffer();l.value="Extracting System Root...";const n=await me.untar(f),i={},p={},b={};for(const o of n)if(o.filename.startsWith("sysroot32/")){const D=o.filename.replace("sysroot32/","");o.fileData&&o.fileData.byteLength>0&&(i[D]=new Uint8Array(o.fileData))}else if(o.filename.startsWith("lib-small/")){const D=o.filename.replace("lib-small/","");o.fileData&&o.fileData.byteLength>0&&(p[D]=new Uint8Array(o.fileData))}else o.fileData&&o.fileData.byteLength>0&&(b[o.filename]=new Uint8Array(o.fileData));l.value="Downloading Compilers...";const[F,E,z]=await Promise.all([fetch("/tools/cobol-wasm/cobc").then(o=>o.arrayBuffer()),fetch("/tools/cobol-wasm/clang").then(o=>o.arrayBuffer()),fetch("/tools/cobol-wasm/wasm-ld").then(o=>o.arrayBuffer())]);m={cobc:new Uint8Array(F),clang:new Uint8Array(E),wasmld:new Uint8Array(z),sysrootFiles:i,libFiles:p,rootFiles:b},_.value=!0,l.value="",V("ready")}catch(a){console.error("Wasmer Init Error",a),l.value="Failed to initialize: "+a.message,e.write(`\r
\x1B[31mError initializing: ${a.message}\x1B[0m\r
`)}finally{r.value=!1}},N=async()=>{if(!m||!_.value)return;r.value=!0,l.value="Compiling...",e.clear();const a=performance.now();try{const t=new y(m.sysrootFiles),f=new y(m.libFiles),n=new y(m.rootFiles),i=new y,p={"/":n,"/sysroot":t,"/lib":f,"/src":i},b={COB_CONFIG_DIR:"/sysroot/share/gnucobol/config"},F="/src";await i.writeFile("test.cob",new TextEncoder().encode(h.value));const E=await x.fromFile(m.cobc);e.write(`Running cobc compilation...\r
`);const o=await(await E.entrypoint.run({args:["-C","-x","/src/test.cob","-o","/src/test.c"],mount:p,env:b,cwd:F})).wait();if(o.code!==0)throw new Error(`cobc failed with code ${o.code}`);e.write(`cobc done.\r
`),e.write(`Running clang...\r
`);const g=await(await(await x.fromFile(m.clang)).entrypoint.run({args:["-cc1","-triple","wasm32-unknown-wasi","-emit-obj","-disable-free","-isysroot","/sysroot","-internal-isystem","/lib/clang/16/include","-internal-isystem","/sysroot/include/wasm32-wasi","-internal-isystem","/sysroot/include","-ferror-limit","19","-o","/src/test.o","-x","c","/src/test.c"],mount:p,env:b,cwd:F})).wait();if(g.stdout&&e.write(g.stdout),g.stderr&&e.write(g.stderr),g.code!==0)throw new Error(`clang failed with code ${g.code}`);e.write(`clang done.\r
`),e.write(`Running wasm-ld...\r
`);const L=await(await(await x.fromFile(m.wasmld)).entrypoint.run({args:["-m","wasm32","-L/sysroot/lib","-L/sysroot/lib/wasm32-wasi","--shared-memory","--max-memory=4294967296","--import-memory","--export-dynamic","--export=__heap_base","--export=__stack_pointer","--export=__data_end","--export=__wasm_init_tls","--export=__wasm_signal","--export=__tls_size","--export=__tls_align","--export=__tls_base","/sysroot/lib/wasm32-wasi/crt1-command.o","/lib/clang/16/lib/wasi/libclang_rt.builtins-wasm32.a","test.o","-lc","-lpthread","-lcob","-lgmp","-lwasi-emulated-signal","-lwasi-emulated-getpid","-lwasi-emulated-mman","-lsetjmp","-ldl","-o","test.wasm"],mount:p,env:b,cwd:F})).wait();if(L.code!==0)throw e.write(L.stderr),new Error(`wasm-ld failed with code ${L.code}`);e.write(`Linking done.\r
`);const K=await i.readFile("test.wasm");e.write(`Running program...\r
`);const q=await(await(await x.fromFile(K)).entrypoint.run({mount:{}})).wait();e.write(q.stdout);const J=performance.now();B.value=(J-a).toFixed(2)}catch(t){console.error(t),e.write(`\r
\x1B[31mError: ${t.message}\x1B[0m\r
`)}finally{r.value=!1,l.value=""}},S=async()=>{try{const a=await ie("cobol");if(I.value=a,a.chapters&&a.chapters.length>0&&a.chapters[0].examples.length>0){const t=a.chapters[0].examples[0];v.value=t.path,h.value=await j("cobol",t.path)}}catch(a){console.error("Failed to load COBOL manifest:",a)}},H=async()=>{if(v.value){e.clear();try{r.value=!0,l.value="Loading example...",h.value=await j("cobol",v.value)}catch(a){e.write(`\x1B[31mFailed to load example: ${a.message}\x1B[0m\r
`)}finally{r.value=!1,l.value=""}}},G=()=>{e.clear(),B.value=null};Z(async()=>{O(),S(),await T(),window.addEventListener("resize",A)}),ee(()=>{window.removeEventListener("resize",A),e&&e.dispose()});const A=()=>{k&&k.fit()};return(a,t)=>{var f;return d(),c("div",ue,[s("div",we,[s("div",fe,[s("div",pe,[t[3]||(t[3]=s("svg",{class:"w-5 h-5 text-blue-500",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"})],-1)),t[4]||(t[4]=s("span",{class:"font-bold text-white"},"COBOL",-1)),s("div",be,[te(s("select",{"onUpdate:modelValue":t[0]||(t[0]=n=>v.value=n),onChange:H,class:"appearance-none bg-slate-700/50 border border-slate-600 text-slate-200 text-xs rounded px-2 pr-6 py-1 hover:border-slate-500 focus:outline-none focus:ring-1 focus:ring-blue-500 transition-all cursor-pointer"},[(d(!0),c(P,null,W((f=I.value)==null?void 0:f.chapters,n=>(d(),c("optgroup",{key:n.title,label:n.title},[(d(!0),c(P,null,W(n.examples,i=>(d(),c("option",{key:i.path,value:i.path},w(i.name),9,xe))),128))],8,ge))),128))],544),[[oe,v.value]]),t[2]||(t[2]=s("div",{class:"absolute inset-y-0 right-1.5 flex items-center pointer-events-none text-slate-400"},[s("svg",{class:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"})])],-1))]),_.value?(d(),c("span",ye,w(R(C)("tools.code-playground.common.ready")),1)):(d(),c("span",he,w(l.value||"Loading..."),1))]),s("button",{onClick:N,disabled:r.value||!_.value,class:se(["px-4 py-1.5 rounded-lg font-medium text-sm transition-colors flex items-center gap-2",r.value||!_.value?"bg-slate-600 text-slate-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-500 text-white"])},[r.value?(d(),c("svg",_e,[...t[5]||(t[5]=[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"},null,-1)])])):(d(),c("svg",ke,[...t[6]||(t[6]=[s("path",{d:"M8 5v14l11-7z"},null,-1)])])),ae(" "+w(r.value?"Running...":R(C)("tools.code-playground.common.run")),1)],10,ve)]),s("div",Fe,[le(re,{modelValue:h.value,"onUpdate:modelValue":t[1]||(t[1]=n=>h.value=n),language:"cobol",height:"100%",minimap:!1},null,8,["modelValue"])])]),s("div",Ce,[s("div",Be,[s("div",De,[s("span",Re,w(R(C)("tools.code-playground.common.output")),1),B.value?(d(),c("span",Ee,w(B.value)+"ms",1)):ne("",!0)]),s("button",{onClick:G,class:"text-xs text-slate-500 hover:text-white transition-colors"},w(R(C)("tools.code-playground.common.clear")),1)]),s("div",Le,[s("div",{ref_key:"terminalContainer",ref:$,class:"w-full h-full"},null,512)])])])}}},Se=X(Me,[["__scopeId","data-v-bbbd0446"]]);export{Se as default};
